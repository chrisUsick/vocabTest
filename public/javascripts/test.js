// Generated by CoffeeScript 1.6.3
(function() {
  var addCategory, addSubject, addTestWord, addUnit, getUnits, host, pageLoad, ws;

  pageLoad = function() {
    ws.send(JSON.stringify({
      request: 'subjectList'
    }));
    return ws.send(JSON.stringify({
      request: 'categoryList'
    }));
  };

  /*
  OBJECT wd {
  	STRING question
  	STRING answer
  }
  */


  addTestWord = function(wd) {
    var mvc, style, view;
    console.log('word to add: ', wd);
    view = '\
		<p>question: <span data-bind="question"/>\
		answer: <input id="input" type=text>\
		<span id="correct"/>\
		<button>show answer</button>\
		<span id="answer" data-bind="answer"/>\
		</p>\
	';
    style = '& span#correct {display: none;} & span#answer {display:none}';
    mvc = $$(wd, {
      format: view,
      style: style
    }, {
      'create': function(e) {
        return $("#testWords p input").focus();
      },
      'change input': function(e) {
        if (this.view.$('#input').val() === this.model.get('answer')) {
          this.view.$('#correct').show().text('correct');
        } else {
          this.view.$('#correct').show().text('incorrect');
        }
        return $("#testType").submit();
      },
      'click button': function(e) {
        return this.view.$('#answer').show();
      }
    });
    return $$.document.prepend(mvc, '#testWords');
  };

  addSubject = function(s) {
    return $('#testType #subject').append("<option>" + s.name + "</option>");
  };

  addCategory = function(c) {
    return $('#category').append("<option>" + c.name + "</option>");
  };

  getUnits = function(sub) {
    return ws.send(JSON.stringify({
      request: 'unitList',
      data: sub
    }));
  };

  addUnit = function(u) {
    return $('#unit').append("<option>" + u.name + "</option>");
  };

  $('#testType').submit(function(e) {
    var d, form, w_or_d;
    e.preventDefault();
    form = '#testType';
    w_or_d = $(form + ' input:radio:checked')[0].id === 'word' ? true : false;
    d = {
      subject: $(form + ' #subject').val(),
      unit: $(form + ' select#unit').val(),
      category: $(form + ' #category').val(),
      w_or_d: w_or_d
    };
    console.log(d);
    return ws.send(JSON.stringify({
      request: 'testWord',
      data: d
    }));
  });

  $('#subject').change(function(e) {
    return getUnits($('#subject').val());
  });

  host = window.document.location.host.replace(/:.*/, '');

  ws = new WebSocket('ws://' + host + ':3000');

  ws.onmessage = function(data) {
    var c, msg, s, u, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
    msg = JSON.parse(data.data);
    console.log('message received:' + msg.response);
    if (msg.response === 'subjectList') {
      _ref = msg.data;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        s = _ref[_i];
        addSubject(s);
      }
    }
    if (msg.response === 'categoryList') {
      _ref1 = msg.data;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        c = _ref1[_j];
        addCategory(c);
      }
    }
    if (msg.response === 'unitList') {
      _ref2 = msg.data;
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        u = _ref2[_k];
        addUnit(u);
      }
    }
    if (msg.response === 'testWord') {
      console.log(msg.data);
      return addTestWord({
        question: msg.data[0].q,
        answer: msg.data[0].a
      });
    }
  };

  ws.onopen = function() {
    console.log('socket open');
    return pageLoad();
  };

  $(window).load(function(e) {
    console.log('loaded');
    if (ws.isopen) {
      return pageLoad();
    }
  });

}).call(this);
